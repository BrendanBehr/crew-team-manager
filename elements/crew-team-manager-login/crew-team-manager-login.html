<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">

<link rel="import" href="../../bower_components/polymerfire/polymerfire.html">

<dom-module id="crew-team-manager-login">
    <template>
        <style>
             :host {
                @apply(--layout-horizontal);
                @apply(--layout-center-justified);
                background-color: #164410;
            }


            #container {
                @apply(--layout-horizontal);
                @apply(--layout-center);
                min-width: 280px;
            }



            #card {
                @apply(--layout-vertical);
                @apply(--layout-center);
                @apply(--layout-flex);
                min-height: 112px;
                background-color: #e8f5e9;
                padding: 24px;
            }

            paper-button.custom:hover {
                background-color: var(--paper-indigo-100);
            }

            #login {
                background-color: var(--paper-indigo-500);
                color: white;
                --paper-button-raised-keyboard-focus: {
                    background-color: var(--paper-pink-a200);
                    color: white;
                }
                ;
            }
        </style>

        <firebase-auth id="auth" user="user" app-name="laborsync-ctm"></firebase-auth>

        <iron-ajax id="token-request" auto url="https://us-central1-laborsync-ctm.cloudfunctions.net/authHttps" headers='{"email":"{{_username}}", "auth":"{{_password}}"}'
            handle-as="json" on-response="_handleTokenRequest" debounce-duration="300" timeout="500"></iron-ajax>

        <div id="container">
            <paper-card id="card">
                <paper-input id="username" label="username" value="{{_username}}"></paper-input>
                <paper-input id="password" label="password" value="{{_password}}" type="password" on-keypress="_keyPressed"></paper-input>
                <paper-button id="login" on-click="_handleLogin">Login</paper-button>
            </paper-card>
        </div>

    </template>


    <script>
        // Extend Polymer.Element with MyMixin
        class crewTeamManagerLogin extends Polymer.Element {

            static get is() {
                return 'crew-team-manager-login'
            }

            static get properties() {
                return {
                    _username: {
                        type: String
                    },

                    _password: {
                        type: String
                    },

                    _token: {
                        type: String
                    }
                }
            }

            _keyPressed(e) {
                if (e.keyCode == 13) {
                    return '_handleLogin'
                }
            }

            _handlleTokenRequest() {


                firebase.initializeApp({
                    credential: this._username,
                    databaseURL: 'https://laborsync-ctm.firebaseio.com'
                });

                console.log(this.$.auth.app.INTERNAL);
                console.log(firebase);
                firebase.auth().createCustomToken(this._username, this._password).catch(function (error) {
                    console.log("Error creating custom token:", error);
                });


                this._token = this.$.auth.INTERNAL.getToken();
            }

            _handleLogin() {

                console.log({
                    Username: this._username,
                    Password: this._password
                });

                document.getElementById('token-request').generateRequest();

                this.$.auth.signInWithCustomToken(this._token)
                    .catch(function (error) {
                        console.log({
                            Code: error.code,
                            MEssage: error.message
                        });

                    });
            }
        }

        // Register custom element definition using standard platform API
        customElements.define(crewTeamManagerLogin.is, crewTeamManagerLogin);
    </script>
</dom-module>